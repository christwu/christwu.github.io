<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.8.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('https://plusnan.me').hostname,
    root: '/',
    scheme: 'Pisces',
    version: '7.7.0',
    exturl: true,
    sidebar: {"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":false}
  };
</script>

  <meta name="description" content="当然，由于不同项目用的东西大概会很不一样，所以本文仅供参考。">
<meta name="keywords" content="Java">
<meta property="og:type" content="article">
<meta property="og:title" content="Java代码审查（一）：代码审查问题">
<meta property="og:url" content="https://plusnan.me/2019/01/02/java-code-review-1/index.html">
<meta property="og:site_name" content="infNaN">
<meta property="og:description" content="当然，由于不同项目用的东西大概会很不一样，所以本文仅供参考。">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2020-01-14T18:20:26.824Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Java代码审查（一）：代码审查问题">
<meta name="twitter:description" content="当然，由于不同项目用的东西大概会很不一样，所以本文仅供参考。">

<link rel="canonical" href="https://plusnan.me/2019/01/02/java-code-review-1/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>

  <title>Java代码审查（一）：代码审查问题 | infNaN</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">infNaN</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope="" itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://plusnan.me/2019/01/02/java-code-review-1/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/img/myavatar.jpg">
      <meta itemprop="name" content="infNaN">
      <meta itemprop="description" content="适量女装，有益身心">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="infNaN">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Java代码审查（一）：代码审查问题
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-01-02 00:00:00" itemprop="dateCreated datePublished" datetime="2019-01-02T00:00:00+08:00">2019-01-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-01-15 02:20:26" itemprop="dateModified" datetime="2020-01-15T02:20:26+08:00">2020-01-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/项目开发经验/" itemprop="url" rel="index">
                    <span itemprop="name">项目开发经验</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>当然，由于不同项目用的东西大概会很不一样，所以本文仅供参考。<br><a id="more"></a></p>
<h1 id="格式与美观问题"><a href="#格式与美观问题" class="headerlink" title="格式与美观问题"></a>格式与美观问题</h1><ul>
<li>命名不规范：例如类名小写字母开头、函数名大写字母开头、拼音英语混写等。由于关于命名规范的资料很多，这里不再列出。</li>
<li>不加空白/空白太多：例如<ul>
<li>没有缩进、缩进混乱、Tab空格混用</li>
<li>if、while、for或运算符之类的没有空格</li>
<li>一行代码后面留好几行空白</li>
<li>不同业务逻辑之间没有空行或“华丽的分割线”<br>以上虽然没有错误，但是不好看。</li>
</ul>
</li>
<li>一行内容太长</li>
<li>代码字符编码或换行符不一致：建议新项目统一用UTF-8字符编码和Unix换行符。</li>
<li>变量、方法顺序混乱</li>
<li><p>表达式太复杂：</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 错误：?:优先级低，导致整个判断条件的逻辑不正确。应该将不同情况用括号包上，分行列举并用注释说明业务规则</span></span><br><span class="line"><span class="keyword">if</span> (year &gt;= nowYear - <span class="number">5</span> &amp;&amp; hasApplied || year &gt;= nowYear - <span class="number">10</span> &amp;&amp; year &lt; nowYear - <span class="number">5</span> &amp;&amp; !hasApplied || year &gt;= hasApplied ? nowYear - <span class="number">20</span> : nowYear - <span class="number">15</span>) &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 修改成</span></span><br><span class="line"><span class="keyword">boolean</span> isValidApply = ((year &gt;= nowYear - <span class="number">5</span>) &amp;&amp; hasApplied) ||         <span class="comment">// 业务规则1</span></span><br><span class="line">    ((year &gt;= nowYear - <span class="number">10</span>) &amp;&amp; (year &lt; nowYear - <span class="number">5</span>) &amp;&amp; !hasApplied) ||  <span class="comment">// 业务规则2</span></span><br><span class="line">    (year &gt;= (hasApplied ? (nowYear - <span class="number">20</span>) : (nowYear - <span class="number">15</span>)));           <span class="comment">// 业务规则3</span></span><br><span class="line"><span class="keyword">if</span> (isValidApply) &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用魔法值（未定义的常量）：建议改用常数或枚举。</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="string">"4"</span>.equals(vo.getStatusFlag())) &#123;   <span class="comment">// 4是什么状态？</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="字符串操作"><a href="#字符串操作" class="headerlink" title="字符串操作"></a>字符串操作</h1><ul>
<li><p>使用==和!=比较字符串：在Java中==和!=比较的不是字符串内容，应该用equals方法。</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 错误</span></span><br><span class="line"><span class="keyword">if</span> (str != <span class="string">""</span>) &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 修改之后</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="string">""</span>.equals(str)) &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>空指针风险：字符串对象和常量比较时，应当把常量放前面，例如</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 错误</span></span><br><span class="line"><span class="keyword">if</span> (str.equals(<span class="string">"A"</span>)) &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 正确：str为null时返回false，不会报错，也不需要另外去判断</span></span><br><span class="line"><span class="keyword">if</span> (<span class="string">"A"</span>.equals(str)) &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>接上条：判断是否为空串时，未判断是否为null。建议改用StringUtils.isEmpty或StringUtils.isNotEmpty。  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 应该是 str != null &amp;&amp; !"".equals(str)</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="string">""</span>.equals(str)) &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>使用equals比较StringBuffer、StringBuilder或Date的值：如果equals前后一个是String，另一个是StringBuffer等对象，那么返回结果一定是false：</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">StringBuilder sql = ...;</span><br><span class="line">Date date = ...;</span><br><span class="line">...</span><br><span class="line"><span class="comment">// 错误：前后类型不一致，结果肯定是false</span></span><br><span class="line"><span class="keyword">if</span> (<span class="string">""</span>.equals(sql)) &#123; ... &#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="string">"2019-01-01"</span>.equals(date)) &#123; ... &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 修改之后</span></span><br><span class="line"><span class="keyword">if</span> (<span class="string">""</span>.equals(sql.toString())) &#123; ... &#125; <span class="comment">// 或者 if (sql.length() == 0) &#123; ... &#125;</span></span><br><span class="line"><span class="keyword">if</span> (<span class="string">"2019-01-01"</span>.equals(<span class="keyword">new</span> SimpleDateFormat(<span class="string">"YYYY-MM-DD"</span>).format(date))) &#123; ... &#125;</span><br><span class="line"><span class="comment">// 或者 if ("2019-01-01".equals(DateFormatUtils.ISO_DATE_FORMAT.format(date))) &#123; ... &#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在for、while循环里面用+=拼接字符串：使用+=拼接字符串的效率比较低，运行数百次就会和StringBuilder产生明显差别，应该用StringBuilder或StringBuffer（如果多线程的话）拼接字符串。</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 错误</span></span><br><span class="line">String output = <span class="string">""</span>;</span><br><span class="line"><span class="keyword">for</span> (...) &#123;</span><br><span class="line">    ...</span><br><span class="line">    output += id + <span class="string">": "</span> + line + <span class="string">"\n"</span>;      <span class="comment">// 直接拼接字符串效率较低</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 修改之后</span></span><br><span class="line">StringBuilder output = <span class="keyword">new</span> StringBuilder();</span><br><span class="line"><span class="keyword">for</span> (...) &#123;</span><br><span class="line">    ...</span><br><span class="line">    output.append(id).append(<span class="string">": "</span>).append(line).append(<span class="string">"\n"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>split之后用固定下标取值：</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">String[] arr = str.split(<span class="string">","</span>);</span><br><span class="line">String val = arr[<span class="number">3</span>];    <span class="comment">// 错误：如果str中分隔符后面没有内容（例如a,,b,c,,），val的位置将不是3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 可以修改成</span></span><br><span class="line">String[] arr = str.split(<span class="string">","</span>, -<span class="number">1</span>);</span><br><span class="line"><span class="comment">// 或者不再依赖位置</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>split时未注意分隔符前后有空格：例如原始数据是<code>1, 2,3 , 4</code>。建议取值之后trim。</p>
</li>
<li>使用split、trim之前未判断是否为null：常见于从数据库获取值之后立即操作。  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String remark = rs.getString(<span class="string">"REMARK"</span>).trim();      <span class="comment">// 错误：未判断REMARK是否为null</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="对象访问"><a href="#对象访问" class="headerlink" title="对象访问"></a>对象访问</h1><ul>
<li><p>在循环里面初始化对象：</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (ApplyFormPO applyForm: applyList) &#123;</span><br><span class="line">    Date now = <span class="keyword">new</span> Date();      <span class="comment">// 浪费资源</span></span><br><span class="line">    ...</span><br><span class="line">    applyForm.setOperating_time(now);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 修改成</span></span><br><span class="line">Date now = <span class="keyword">new</span> Date();</span><br><span class="line"><span class="keyword">for</span> (ApplyFormPO applyForm: applyList) &#123;</span><br><span class="line">    ...</span><br><span class="line">    applyForm.setOperating_time(now);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  需要注意的是，并不是所有在循环里初始化对象的代码都有问题，例如下面代码就不能向上面那样改：</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">List&lt;ApplyFormPO&gt; applyList = <span class="keyword">new</span> ArrayList&lt;ApplyFormPO&gt;();</span><br><span class="line"><span class="keyword">for</span> (...) &#123;</span><br><span class="line">    ApplyFormPO applyForm = <span class="keyword">new</span> ApplyFormPO();      <span class="comment">// 这个不能放到for外面，因List里面保存的是对象引用</span></span><br><span class="line">    ...</span><br><span class="line">    applyList.add(applyForm);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>空指针：在DAO、List、Map等地方取值时未判断是否为null，例如</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 错误：未判断list的元素个数</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="string">""</span>.equals(list.get(<span class="number">0</span>).getStatus()) &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 错误：未判断中间变量A和B是否为null</span></span><br><span class="line"><span class="keyword">if</span> (obj.getA().getB().isC()) &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>包装类比较==或!=：</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Integer i1 = ...;</span><br><span class="line">Integer i2 = ...;</span><br><span class="line"><span class="comment">// 错误：下面比较的不是i1和i2的值</span></span><br><span class="line"><span class="keyword">if</span> (i1 == i2) &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>顺便提一下，float、double即使不是包装类也不能用==或!=比较，因为存在精度问题。</li>
</ul>
</li>
<li><p>在for循环里添加或删除集合中的元素：</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (Item obj: itemList) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">"d"</span>.equals(obj.getFlag()) &#123;</span><br><span class="line">        itemList.remove(obj);       <span class="comment">// 错误：会破坏for循环</span></span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 修改方法：使用Iterator操作删除，或者再创建一个List，将删除操作反映到新List中</span></span><br><span class="line">List&lt;Item&gt; newItemList = <span class="keyword">new</span> ArrayList&lt;Item&gt;();</span><br><span class="line"><span class="keyword">for</span> (Item obj: itemList) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="string">"d"</span>.equals(obj.getFlag()) &#123;</span><br><span class="line">        newItemList.add(obj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (Item obj: newItemList) &#123; <span class="comment">// 后续操作使用newItemList，或者以 itemList = newItemList; 替换</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>static SimpleDateFormat：SimpleDateFormat不是线程安全的，其实例不应定义成静态变量。建议不再使用SimpleDateFormat，而是改用DateFormatUtils。</p>
</li>
<li><p>工具类未使用static定义，或者static方法仍然在new对象之后调用：</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StringUtils</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 错误：应改成static</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isEmpty</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (str == <span class="keyword">null</span>) || (str.length() == <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">StringUtils su = <span class="keyword">new</span> StringUtils();     <span class="comment">// 改成static之后无需再实例化，以免浪费资源</span></span><br><span class="line"><span class="keyword">if</span> (su.isEmpty(str)) &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h1><ul>
<li>将异常用作流程控制：该用if-else进行判断的地方不要用try-catch，因为效率低以及语义不同。</li>
<li>在for或while中try-catch：同样消耗资源，建议将try块挪到循环外面。</li>
<li><p>捕获/抛出NullPointerException或IndexOutOfBoundsException等异常：空指针、索引越界等问题应当使用if判断来避免，而且此类问题有可能是业务层面问题，不应靠异常机制处理。</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">String result;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">"A"</span>.equals(poList.get(<span class="number">0</span>).getFlag())) &#123;</span><br><span class="line">        result = <span class="string">"Y"</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        result = <span class="string">"N"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (NullPointerException e) &#123;          <span class="comment">// 错误：应当避免使程序产生此类异常</span></span><br><span class="line">    result = <span class="string">"E"</span>;</span><br><span class="line">&#125; <span class="keyword">catch</span> (IndexOutOfBoundsException e) &#123;     <span class="comment">// 错误：应当避免使程序产生此类异常</span></span><br><span class="line">    result = <span class="string">"E"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 修改成</span></span><br><span class="line"><span class="keyword">if</span> (poList == <span class="keyword">null</span> || poList.size() == <span class="number">0</span>) &#123;</span><br><span class="line">    result = <span class="string">"E"</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">"A"</span>.equals(poList.get(<span class="number">0</span>).getFlag())) &#123;</span><br><span class="line">        result = <span class="string">"Y"</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        result = <span class="string">"N"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>打印日志：</p>
<ul>
<li>发生异常却未向用户反馈，仍然提示“成功”：实际上已经出错了，应当提示出来。如果确定对用户没有影响，可以忽略，那么应当在注释中明确指出来。</li>
<li><p>报错信息缺少用户能看懂的语言：应当先提示用户能看得懂的内容，给出大概的错误原因和处理方法。</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    setMessage(<span class="string">"保存成功！"</span>, MessageLevel.SUCCESS);</span><br><span class="line">&#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">    setMessage(e.getMessage(), MessageLevel.ERROR); <span class="comment">// 错误：用户看不懂Exception的内容</span></span><br><span class="line">    logger.debug(<span class="string">"保存过程中发生内部错误"</span>, e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>日志级别与实际情况不一致：例如用error输出调试内容、用debug输出错误信息。</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    setMessage(<span class="string">"保存成功！"</span>, MessageLevel.SUCCESS);</span><br><span class="line">&#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">    setMessage(<span class="string">"保存过程中发生内部错误："</span> + e.getMessage() + <span class="string">"！"</span>, MessageLevel.ERROR);</span><br><span class="line">    logger.debug(<span class="string">"保存过程中发生内部错误"</span>, e);      <span class="comment">// 错误：应该是error</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  如果系统在上线一段时间之后已经比较稳定，建议提高日志级别，以节约服务器空间和I/O资源消耗。</p>
</li>
<li>屏幕提示和日志记录不一致：  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    setMessage(<span class="string">"保存成功！"</span>, MessageLevel.SUCCESS);</span><br><span class="line">&#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">    setMessage(<span class="string">"保存过程中发生内部错误："</span> + e.getMessage() + <span class="string">"！"</span>, MessageLevel.ERROR);</span><br><span class="line">    logger.error(<span class="string">"查询工作单信息出错"</span>, e);      <span class="comment">// 错误：与屏幕提示不一致，找日志时会产生困扰</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>捕获异常但未做任何处理：一旦出现异常，开发人员将无法进行诊断。</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    e.printStackTrace();        <span class="comment">// 应向用户反馈（最外层）或向上抛（不是最外层的话）</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>重复捕获异常：在业务层捕获异常，使得业务调用者无法得知异常，也无法向用户提供反馈。</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 业务逻辑</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BusinessBO</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ApplyPO <span class="title">getApplyInfo</span><span class="params">(String applyId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ...     <span class="comment">// 业务逻辑</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            logger.error(<span class="string">"查询时发生异常"</span>, e);</span><br><span class="line">            <span class="comment">// 错误：业务层的异常未往上抛，这样即使发生异常用户也无法收到反馈</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 业务调用者</span></span><br><span class="line"><span class="meta">@Controller</span>()</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BusinessController</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/apply/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getApplyInfo</span><span class="params">(...)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ApplyPO applypo = BusinessBO.getApplyInfo(id);</span><br><span class="line">            ...</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// 虽然使用Exception不会产生编译错误，但是这里根本捕捉不到异常</span></span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在Web请求层（SpringMVC的Controller、Struts的Action）或WebService服务上面抛出异常：服务调用者无法捕获服务抛出的异常，顶多能够得知服务返回了500状态码（然而这样是不对的）。应该由双方约定错误信息格式，将抛出异常改成返回错误码。</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WebService</span>(endpointInterface = <span class="string">"com.company.BusinessService"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BusinessService</span> <span class="keyword">implements</span> <span class="title">IBusinessService</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 错误示例 - Service不能抛出异常</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">doJob</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 正确示例 - 返回错误码，使调用者得知接口通了，但是结果异常</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">doJob</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String result = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ...</span><br><span class="line">            result = <span class="string">"&#123;\"result\": \"SUCCESS\", \"info\": \"操作成功\"&#125;"</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            ...</span><br><span class="line">            result = <span class="string">"&#123;\"result\": \"E01\", \"info\": \"操作失败，数据库异常\"&#125;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="数据库操作"><a href="#数据库操作" class="headerlink" title="数据库操作"></a>数据库操作</h1><ul>
<li><p>未关闭资源：未关闭ResultSet、PrepareStatement、Connection或者各种（不一定是数据库的）流。</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">Connection conn = ...;</span><br><span class="line">PreparedStatement stmt = <span class="keyword">null</span>;</span><br><span class="line">ResultSet rs = <span class="keyword">null</span>;</span><br><span class="line"><span class="comment">// 错误：未关闭资源</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    stmt = conn.prepareStatement(<span class="string">"..."</span>);</span><br><span class="line">    rs = stmt.executeQuery();</span><br><span class="line">    <span class="keyword">while</span> (rs.next()) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 应在finally中释放资源</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    stmt = ...</span><br><span class="line">    ...</span><br><span class="line">&#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (rs != <span class="keyword">null</span>) &#123; rs.close(); &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (stmt != <span class="keyword">null</span>) &#123; stmt.close(); &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (conn != <span class="keyword">null</span>) &#123; conn.close(); &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在循环中操作数据库：建立连接、执行SQL和关闭连接需要时间，虽然一次执行时间可能不长，但是在循环中累积会很耗时。因此应当减少数据库操作次数，一次性查询好，或者使用批处理一次性执行修改。</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (String id: idList) &#123;</span><br><span class="line">    <span class="comment">// 从数据库获取对象</span></span><br><span class="line">    ItemPO item = getItem(id);   <span class="comment">// 错误：在for循环中操作数据库</span></span><br><span class="line">    <span class="comment">// 进行修改</span></span><br><span class="line">    item.setColA(...);</span><br><span class="line">    item.setColB(...);</span><br><span class="line">    <span class="comment">// 将修改保存到数据库中</span></span><br><span class="line">    updateItem(item);     <span class="comment">// 错误：在for循环中操作数据库</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 修改成（假定itemList还有其他用途，要不然直接UPDATE就行了）</span></span><br><span class="line"><span class="comment">// 一次性将idList里的数据都取出来</span></span><br><span class="line">List&lt;ItemPO&gt; itemList = getItemList(idList);</span><br><span class="line"><span class="comment">// 将itemList装到Map中以便查询</span></span><br><span class="line">Map&lt;String, ItemPO&gt; itemMap = <span class="keyword">new</span> HashMap&lt;String, ItemPO&gt;();</span><br><span class="line"><span class="keyword">for</span> (ItemPO item: itemList) &#123;</span><br><span class="line">    itemMap.put(item.getId(), item);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PreparedStatement stmt = connection.prepareStatement(<span class="string">"UPDATE BUSINESS SET AAA=?, BBB=? WHERE ID=?"</span>);</span><br><span class="line"><span class="keyword">for</span> (String id: idList) &#123;</span><br><span class="line">    <span class="comment">// 从Map获取对象</span></span><br><span class="line">    ItemPO item = itemMap.get(id);</span><br><span class="line">    <span class="comment">// 进行修改</span></span><br><span class="line">    stmt.setString(<span class="number">1</span>, ...);</span><br><span class="line">    stmt.setString(<span class="number">2</span>, ...);</span><br><span class="line">    stmt.setString(<span class="number">3</span>, item.getId());</span><br><span class="line">    <span class="comment">// 加入批处理</span></span><br><span class="line">    stmt.addBatch();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 执行批处理</span></span><br><span class="line">stmt.executeBatch();</span><br></pre></td></tr></table></figure>
</li>
<li><p>getString之后未判断是否为null，或者从DAO取值后未判断是否为null：从可空字段取值之后，返回的可能是null。</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String remark = rs.getString(<span class="string">"REMARK"</span>).trim();      <span class="comment">// 错误：未判断是否为null</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>事务</p>
<ul>
<li>该有事务的地方没加事务：对于一系列数据库修改操作而言，如果这些操作应当“共进退”，即要么全部执行完，要么出错之后能够全部恢复，那么应当加入事务控制。</li>
<li><p>发生异常时未回滚事务：</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    conn.setAutoCommit(<span class="keyword">false</span>);</span><br><span class="line">    ...</span><br><span class="line">    conn.commit();</span><br><span class="line">&#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">    <span class="comment">// 错误：此处应有conn.rollback();</span></span><br><span class="line">    ...</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>重复提交/回滚事务：已经commit/rollback之后又执行了commit/rollback。如果在开启事务之后调用了一些函数，但是未注意到函数里面也有事务控制，那么结果可能会出错。</p>
</li>
</ul>
</li>
<li><p>该加锁的地方没加锁：例如从流水号表取下一流水号</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getNextSerial</span><span class="params">(String businessType)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        stmt = conn.prepareStatement(<span class="string">"SELECT NEXT_NO FROM T_SERIAL WHERE ..."</span>);</span><br><span class="line">        stmt.setString(<span class="number">1</span>, ...);</span><br><span class="line">        rs = stmt.executeQuery();</span><br><span class="line">        <span class="keyword">if</span> (rs.next()) &#123;</span><br><span class="line">            <span class="keyword">int</span> next_no = rs.getInt(<span class="string">"NEXT_NO"</span>);</span><br><span class="line">            result = businessType + <span class="string">"-"</span> + next_no;</span><br><span class="line">            <span class="comment">// 将流水号表中的记录加1</span></span><br><span class="line">            ...</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 将初始值置为1，并向流水号表插入记录</span></span><br><span class="line">            ...     </span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  假如NEXT_NO为5，那么在并发条件下各用户获取到的可能都是5，从而产生冲突，因此需要通过加锁进行控制（例如synchronized）。另外注意这种代码在读取数据时就发生了冲突，所以光加事务控制是不起作用的。</p>
</li>
</ul>
<h1 id="SQL语句"><a href="#SQL语句" class="headerlink" title="SQL语句"></a>SQL语句</h1><ul>
<li><p>SQL语法错误：例如引号不配对、括号不配对、数据类型不匹配，或者拼接的SQL缺空格、有多余AND和多余逗号等。</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">StringBuilder sql = <span class="keyword">new</span> StringBuilder(<span class="string">"SELECT ID,NAME FROM TAB WHERE"</span>);</span><br><span class="line"><span class="keyword">if</span> (StringUtils.isNotEmpty(cond1)) &#123;</span><br><span class="line">    <span class="comment">// 两个错误：一个是缺空格，另一个是在WHERE后面直接拼接AND了</span></span><br><span class="line">    sql.append(<span class="string">"AND cond1='"</span>).append(escapeSQL(cond1)).append(<span class="string">"'"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (StringUtils.isNotEmpty(cond2)) &#123;</span><br><span class="line">    sql.append(<span class="string">" AND cond2 IN ("</span>);</span><br><span class="line">    String[] arr = cond2.split(<span class="string">","</span>);</span><br><span class="line">    <span class="keyword">for</span> (String s: arr) &#123;</span><br><span class="line">        sql.append(<span class="string">"'"</span>).append(escapeSQL(s)).append(<span class="string">"',"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 错误：未处理最后一个多余的逗号</span></span><br><span class="line">    sql.append(<span class="string">")"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用SELECT *：应当写清字段名而非简单粗暴的*。</p>
</li>
<li>直接拼接SQL：未对用户输入进行处理，会导致SQL注入，应该用PreparedStatement或者使用转义函数对用户输入内容转义。<ul>
<li>接上条，要避免重复转义。</li>
</ul>
</li>
<li><p>对可空字段使用&lt;&gt;或NOT IN：应注意单独判断NULL值。</p>
  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 假设FLAG是可空字段，那么以下都是有问题的</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">ID</span>, <span class="keyword">NAME</span> <span class="keyword">FROM</span> TAB <span class="keyword">WHERE</span> FLAG&lt;&gt;<span class="string">'1'</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">ID</span>, <span class="keyword">NAME</span> <span class="keyword">FROM</span> TAB <span class="keyword">WHERE</span> FLAG <span class="keyword">NOT</span> <span class="keyword">IN</span> (<span class="string">'1'</span>, <span class="string">'2'</span>);</span><br><span class="line"><span class="comment">-- 应修改成（下面只考虑NULL问题，不考虑效率问题）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">ID</span>, <span class="keyword">NAME</span> <span class="keyword">FROM</span> TAB <span class="keyword">WHERE</span> FLAG&lt;&gt;<span class="string">'1'</span> <span class="keyword">OR</span> FLAG <span class="keyword">IS</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">ID</span>, <span class="keyword">NAME</span> <span class="keyword">FROM</span> TAB <span class="keyword">WHERE</span> FLAG <span class="keyword">NOT</span> <span class="keyword">IN</span> (<span class="string">'1'</span>, <span class="string">'2'</span>) <span class="keyword">OR</span> FLAG <span class="keyword">IS</span> <span class="literal">NULL</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>子查询返回多条记录：</p>
  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">ID</span>, <span class="keyword">NAME</span> <span class="keyword">FROM</span> TAB <span class="keyword">WHERE</span> BUSINO=(<span class="keyword">SELECT</span> BUSINO <span class="keyword">FROM</span> APPL <span class="keyword">WHERE</span> ...);</span><br><span class="line"><span class="comment">-- 如果查询APPL会返回多条记录，那么会出错，因此需要调整子查询条件，保证至多返回一条记录，例如（Oracle）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">ID</span>, <span class="keyword">NAME</span> <span class="keyword">FROM</span> TAB <span class="keyword">WHERE</span> BUSINO=(<span class="keyword">SELECT</span> BUSINO <span class="keyword">FROM</span> APPL <span class="keyword">WHERE</span> ... <span class="keyword">AND</span> <span class="keyword">ROWNUM</span>=<span class="number">1</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>用==或&lt;&gt;判断NULL：应使用IS NULL或IS NOT NULL进行判断。</p>
</li>
<li>IN后面没有值，或者取值超过了1000个。</li>
<li><p>参数校验不完整：假如HUGE_TABLE是张很大的表，对于下面代码而言，只要构造不含任何条件的请求，那么就可以把系统搞瘫痪。</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 绕过前台校验，不传任何条件，使程序直接查全表</span></span><br><span class="line">StringBuilder sql = <span class="keyword">new</span> StringBuilder(<span class="string">"SELECT NAME,DESCRIPTION FROM HUGE_TABLE WHERE 1=1"</span>);</span><br><span class="line"><span class="keyword">if</span> (StringUtils.isNotEmpty(cond1)) &#123;</span><br><span class="line">    sql.append(<span class="string">" AND COND1='"</span>).append(escapeSQL(cond1)).append(<span class="string">"'"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (StringUtils.isNotEmpty(cond2)) &#123;</span><br><span class="line">    sql.append(<span class="string">" AND COND2='"</span>).append(escapeSQL(cond2)).append(<span class="string">"'"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (StringUtils.isNotEmpty(cond3)) &#123;</span><br><span class="line">    sql.append(<span class="string">" AND COND3='"</span>).append(escapeSQL(cond3)).append(<span class="string">"'"</span>);</span><br><span class="line">&#125;</span><br><span class="line">PreparedStatement stmt = conn.prepareStatement(sql.toString());</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>  另外两个例子：</p>
<ul>
<li>如果分页程序未对每页最多记录数进行限制，那么用户可以让每页显示10000条记录，从而影响系统运行。</li>
<li>如果参数作为UPDATE或DELETE的条件来使用，那么绕过校验会产生灾难性后果。</li>
</ul>
</li>
</ul>
<h1 id="页面"><a href="#页面" class="headerlink" title="页面"></a>页面</h1><h2 id="HTML-JSP"><a href="#HTML-JSP" class="headerlink" title="HTML/JSP"></a>HTML/JSP</h2><ul>
<li>使用过时的标签和属性，例如&lt;font&gt;或者&lt;span color=”red”&gt;。</li>
<li>HTML标签不匹配。</li>
<li>修改表格标题内容，未修改待展示的数据，或者未修改带有colspan的单元格。</li>
<li>不经转义直接输出动态内容：容易导致XSS注入。</li>
</ul>
<h2 id="JavaScript"><a href="#JavaScript" class="headerlink" title="JavaScript"></a>JavaScript</h2><ul>
<li>使用document.getElementById等函数之后未判断是否为null。</li>
<li>动态添加控件后未绑定事件。<ul>
<li>接上条，动态添加控件后，选择器有误，导致既有控件又绑了一遍事件。</li>
</ul>
</li>
<li>进行AJAX操作，未处理请求超时、请求错误和返回错误码的情况。</li>
<li>后台使用GB2312，前台AJAX内容含有中文，但未进行转码处理。</li>
<li>点击提交、删除等具有危险性的按钮，系统直接执行操作，不给出任何确认提示。</li>
<li>进行保存、提交等耗时操作时没有等待提示，也未将控制按钮变灰：这样容易使用户以为操作不成功而重复点击。</li>
</ul>
<h1 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h1><ul>
<li>线程安全问题：例如使用静态HashMap实例进行缓存。</li>
<li>没有设置连接超时：一旦数据库或接口卡死，而用户还在正常使用系统，那么程序会消耗越来越多的资源，最终导致响应慢甚至崩溃。</li>
</ul>
<h1 id="本系列目录"><a href="#本系列目录" class="headerlink" title="本系列目录"></a>本系列目录</h1><ol>
<li><strong>代码审查问题</strong></li>
<li><a href="/2019/01/03/java-code-review-2">应用安全问题</a></li>
<li><a href="/2019/01/04/java-code-review-3">关于编程习惯的要求</a></li>
<li><a href="/2019/02/06/java-code-review-4">使用Phabricator进行人工代码审查</a></li>
<li>使用FindBugs和SonarQube等工具进行扫描</li>
<li>……</li>
</ol>

    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>infNaN
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://plusnan.me/2019/01/02/java-code-review-1/" title="Java代码审查（一）：代码审查问题">https://plusnan.me/2019/01/02/java-code-review-1/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC8="><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</span> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Java/" rel="tag"># Java</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2019/01/01/java-code-review-0/" rel="prev" title="Java代码审查：目录">
      <i class="fa fa-chevron-left"></i> Java代码审查：目录
    </a></div>
      <div class="post-nav-item">
    <a href="/2019/01/03/java-code-review-2/" rel="next" title="Java代码审查（二）：应用安全问题">
      Java代码审查（二）：应用安全问题 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#格式与美观问题"><span class="nav-number">1.</span> <span class="nav-text">格式与美观问题</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#字符串操作"><span class="nav-number">2.</span> <span class="nav-text">字符串操作</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#对象访问"><span class="nav-number">3.</span> <span class="nav-text">对象访问</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#异常处理"><span class="nav-number">4.</span> <span class="nav-text">异常处理</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#数据库操作"><span class="nav-number">5.</span> <span class="nav-text">数据库操作</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#SQL语句"><span class="nav-number">6.</span> <span class="nav-text">SQL语句</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#页面"><span class="nav-number">7.</span> <span class="nav-text">页面</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#HTML-JSP"><span class="nav-number">7.1.</span> <span class="nav-text">HTML/JSP</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JavaScript"><span class="nav-number">7.2.</span> <span class="nav-text">JavaScript</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#其他"><span class="nav-number">8.</span> <span class="nav-text">其他</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#本系列目录"><span class="nav-number">9.</span> <span class="nav-text">本系列目录</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="infNaN" src="/img/myavatar.jpg">
  <p class="site-author-name" itemprop="name">infNaN</p>
  <div class="site-description" itemprop="description">适量女装，有益身心</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">27</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">30</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2luZm5hbg==" title="GitHub → https://github.com/infnan"><i class="fa fa-fw fa-github"></i>GitHub</span>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:me@plusnan.me" title="E-Mail → mailto:me@plusnan.me"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <span class="exturl cc-opacity" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC8="><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 2018 – 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">infNaN</span>
</div>
  <div class="powered-by">由 <span class="exturl theme-link" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> 强力驱动
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <span class="exturl theme-link" data-url="aHR0cHM6Ly9waXNjZXMudGhlbWUtbmV4dC5vcmc=">NexT.Pisces</span>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
<script src="/js/utils.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>



  
  <script>
    (function(){
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      bp.src = (curProtocol === 'https') ? 'https://zz.bdstatic.com/linksubmit/push.js' : 'http://push.zhanzhang.baidu.com/push.js';
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  </script>















  

  

</body>
</html>
