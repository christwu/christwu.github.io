<!DOCTYPE html>
<html>
<head>
    

    

    



    <meta charset="utf-8">
    
    
    
    
    <title>Weblogic踩坑记录 | 一点微小的博客 | 走向女装之路</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="Weblogic">
    <meta name="description" content="本文记录我在部署Weblogic时遇到的各种坑。其中JDK为1.6，Weblogic版本11g。">
<meta name="keywords" content="Weblogic">
<meta property="og:type" content="article">
<meta property="og:title" content="Weblogic踩坑记录">
<meta property="og:url" content="https://plusnan.me/2018/11/02/weblogic-caution/index.html">
<meta property="og:site_name" content="一点微小的博客">
<meta property="og:description" content="本文记录我在部署Weblogic时遇到的各种坑。其中JDK为1.6，Weblogic版本11g。">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2018-11-28T03:40:06.383Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Weblogic踩坑记录">
<meta name="twitter:description" content="本文记录我在部署Weblogic时遇到的各种坑。其中JDK为1.6，Weblogic版本11g。">
    
        <link rel="alternate" type="application/atom+xml" title="一点微小的博客" href="/rss.xml">
    
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="stylesheet" href="/css/style.css?v=1.7.2">
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    

</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/myavatar.jpg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">InfNaN</h5>
          <a href="mailto:me@plusnan.me" title="me@plusnan.me" class="mail">me@plusnan.me</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                主页
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                存档
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                标签
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                分类
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/infnan" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                GitHub
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/rss.xml" target="_blank" >
                <i class="icon icon-lg icon-rss"></i>
                RSS
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">Weblogic踩坑记录</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="输入感兴趣的关键字">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">Weblogic踩坑记录</h1>
        <h5 class="subtitle">
            
                <time datetime="2018-11-01T16:00:00.000Z" itemprop="datePublished" class="page-time">
  2018-11-02
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/经验/">经验</a></li></ul>

            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap post-toc-shrink" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#开发阶段"><span class="post-toc-number">1.</span> <span class="post-toc-text">开发阶段</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#中间件版本保持一致"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">中间件版本保持一致</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#数据源问题"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">数据源问题</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Session丢失问题"><span class="post-toc-number">1.3.</span> <span class="post-toc-text">Session丢失问题</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#部署阶段"><span class="post-toc-number">2.</span> <span class="post-toc-text">部署阶段</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#防火墙配置"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">防火墙配置</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#不要忘记网络测试"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">不要忘记网络测试</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#修改java-security"><span class="post-toc-number">2.3.</span> <span class="post-toc-text">修改java.security</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#如果通过控制台启动服务器时起不来"><span class="post-toc-number">2.4.</span> <span class="post-toc-text">如果通过控制台启动服务器时起不来</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#方法一：重新设置证书"><span class="post-toc-number">2.4.1.</span> <span class="post-toc-text">方法一：重新设置证书</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#方法二：不使用SSL"><span class="post-toc-number">2.4.2.</span> <span class="post-toc-text">方法二：不使用SSL</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#组建集群"><span class="post-toc-number">2.5.</span> <span class="post-toc-text">组建集群</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#增加线程数"><span class="post-toc-number">2.6.</span> <span class="post-toc-text">增加线程数</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#运维阶段"><span class="post-toc-number">3.</span> <span class="post-toc-text">运维阶段</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#应用升级"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">应用升级</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#重启服务器"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">重启服务器</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#打补丁"><span class="post-toc-number">3.3.</span> <span class="post-toc-text">打补丁</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#搬家"><span class="post-toc-number">3.4.</span> <span class="post-toc-text">搬家</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#监控"><span class="post-toc-number">3.5.</span> <span class="post-toc-text">监控</span></a></li></ol></li></ol>
        </nav>
    </aside>


<article id="post-weblogic-caution"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">Weblogic踩坑记录</h1>
        <div class="post-meta">
            <time class="post-time" title="2018-11-02 00:00:00" datetime="2018-11-01T16:00:00.000Z"  itemprop="datePublished">2018-11-02</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/经验/">经验</a></li></ul>



            

        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <p>本文记录我在部署Weblogic时遇到的各种坑。其中JDK为1.6，Weblogic版本11g。<br><a id="more"></a></p>
<style>
#post-content table {
    word-break: break-all;
}
</style>

<h1 id="开发阶段"><a href="#开发阶段" class="headerlink" title="开发阶段"></a>开发阶段</h1><h2 id="中间件版本保持一致"><a href="#中间件版本保持一致" class="headerlink" title="中间件版本保持一致"></a>中间件版本保持一致</h2><p>开发环境、测试环境和生产环境的JDK与中间件版本应该保持一致，至少测试环境和生产环境要一致。开发时用某个版本JDK和Tomcat，部署到生产环境时用另一个版本的JDK和Weblogic，这样很容易遭遇意外。</p>
<p>举一些例子，以下几个就属于Tomcat上面测不出来，挪到Weblogic上面就可能会暴露出来的错误。修改Weblogic服务器启动参数可能能在一定程度上解决：</p>
<table>
<thead>
<tr>
<th>场景</th>
<th>错误信息</th>
<th>启动参数</th>
</tr>
</thead>
<tbody>
<tr>
<td>生成图片</td>
<td>java.awt.HeadlessException</td>
<td>-Djava.awt.headless=true</td>
</tr>
<tr>
<td>访问HTTPS网站</td>
<td>javax.net.ssl.SSLHandshakeException: sun.security.validator.ValidatorException: No trusted certificate found exception</td>
<td>-DUseSunHttpHandler=true</td>
</tr>
<tr>
<td>Apache CXF提供WebService服务</td>
<td>javax.xml.ws.soap.SOAPFaultException: Cannot create a secure XMLInputFactory</td>
<td>-Dorg.apache.cxf.stax.allowInsecureParser=1</td>
</tr>
</tbody>
</table>
<p>##路径问题<br>假设程序部署在服务器的/home/weblogic/project中，Weblogic安装在/u01/Oracle/Middleware下面，而且程序会动态生成文件，实际上文件会放在类似于/u01/Oracle/Middleware/user_projects/domains/base_domain/servers/app_server1/stage/project的对应位置中。</p>
<p>避免使用中文文件名和中文路径，以免因字符编码问题导致部署或升级失败。举个例子，如果文件里有中文名，打包并解压之后文件名变成了乱码，那么更新的时候Weblogic会提示“Error occurred while downloading files from admin server for deployment request “xxx,xxx,xxx”. Underlying error is: “null””。</p>
<h2 id="数据源问题"><a href="#数据源问题" class="headerlink" title="数据源问题"></a>数据源问题</h2><p>假如JNDI数据源名称为dataSource，在Tomcat中运行时，需要写成java:comp/env/dataSource，但是在Weblogic中运行时要把“java:comp/env/”去掉，直接写成dataSource。</p>
<h2 id="Session丢失问题"><a href="#Session丢失问题" class="headerlink" title="Session丢失问题"></a>Session丢失问题</h2><p>生产环境通常会架设集群，通过负载均衡进行访问。如果负载均衡未按照Cookie进行分配，或者分配策略不完全正确，那么这样的话很可能会存在串Session的问题，例如登录成功之后进的是节点1，稍微做点操作后默默地跳到了节点3，导致会话丢失，系统提示重新登录。因为平时开发不会去使用负载均衡，所以可能注意不到这个问题。</p>
<p>这个问题可以通过以下几种方法解决：</p>
<ol>
<li>正确地配置负载均衡，保证同一会话的流量只分配到同一节点上；</li>
<li>使用Weblogic的“会话复制”功能；</li>
<li>通过Redis等实现会话共享。</li>
</ol>
<p>会话复制的操作方法可以用Google搜索。由于我们项目比较特殊，所以使用的方法和以上三种均不相同（用户认证和会话控制由集成在上游的系统管理，请求通过上游的反向代理传过来，用户信息保存在特定HTTP Header中，而我们自己项目内的用户验证在Filter中进行，一旦Session丢掉可以直接根据Header信息重建）。</p>
<h1 id="部署阶段"><a href="#部署阶段" class="headerlink" title="部署阶段"></a>部署阶段</h1><h2 id="防火墙配置"><a href="#防火墙配置" class="headerlink" title="防火墙配置"></a>防火墙配置</h2><p>默认情况下，管理控制台的端口是7001，应用是7003，节点管理器是5556，初次部署时需要注意让防火墙放行这三个端口。</p>
<p>为了安全，需要仔细控制防火墙的放行范围，不要让7001和5556暴露到互联网上面。另外不要把应用部署到AdminServer上面，否则封锁7001端口之后应用就无法访问了。</p>
<h2 id="不要忘记网络测试"><a href="#不要忘记网络测试" class="headerlink" title="不要忘记网络测试"></a>不要忘记网络测试</h2><p>在开始部署之前，需要在应用服务器上测试一下能否访问数据库等资源。如果网络不通，那么改Weblogic设置时可能会无响应，卡了半天之后才蹦出一句“The Network adapter could not establish the connection”，白白耽误时间。</p>
<p>可以通过以下Java程序来测一下端口通不通，或者简单地测试一下能不能ping通（但是有些机房可能会出现IP能ping通但是端口访问被拦截的情况）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IpTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        Socket connect = <span class="keyword">new</span> Socket();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String ip = <span class="string">""</span>;</span><br><span class="line">            <span class="keyword">int</span> port = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">int</span> timeout = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (args.length &lt; <span class="number">2</span>) &#123;</span><br><span class="line">                System.out.println(<span class="string">"用法：java IpTest &lt;IP地址&gt; &lt;端口号&gt; [超时时间]"</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ip = args[<span class="number">0</span>];</span><br><span class="line">                port = Integer.parseInt(args[<span class="number">1</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (args.length &gt; <span class="number">2</span>)&#123;</span><br><span class="line">                timeout = Integer.parseInt(args[<span class="number">2</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"正在连接 "</span> + ip + <span class="string">":"</span> + port);</span><br><span class="line"></span><br><span class="line">            InetSocketAddress addr = <span class="keyword">new</span> InetSocketAddress(ip, port);</span><br><span class="line">            connect.connect(addr, timeout);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (connect.isConnected()) &#123;</span><br><span class="line">                System.out.println(<span class="string">"连接成功"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">"连接失败"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                connect.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">javac IpTest.java</span><br><span class="line">java IpTest 10.15.2.9 1521</span><br></pre></td></tr></table></figure>
<h2 id="修改java-security"><a href="#修改java-security" class="headerlink" title="修改java.security"></a>修改java.security</h2><p>Java 6存在一个关于随机数的bug，如果不Hack，在Linux系统下面Weblogic建域和启动时需要等待很长时间，因此建议装完Java之后立刻去修改java.security。</p>
<p>假设JDK安装在/opt/jdk1.6.0_145下面（即\$JAVA_HOME），则需要修改\$JAVA_HOME/jre/lib/security/java.security文件，找到</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">securerandom.source=file:/dev/urandom</span><br></pre></td></tr></table></figure>
<p>修改成</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">securerandom.source=file:/dev/./urandom</span><br></pre></td></tr></table></figure>
<p>之后建域和起停之类操作就不需要再等待十多分钟了。</p>
<h2 id="如果通过控制台启动服务器时起不来"><a href="#如果通过控制台启动服务器时起不来" class="headerlink" title="如果通过控制台启动服务器时起不来"></a>如果通过控制台启动服务器时起不来</h2><p>如果Weblogic各节点已正确设置，各服务器的防火墙已经开放5556端口，NodeManager也已经启动，但是仍然无法通过控制台启动节点，提示“不兼容的状态”，而且在startNodeManager.sh的输出中出现“javax.net.ssl.SSLKeyException: [Security:090482]BAD_CERTIFICATE alert was received from …”：</p>
<h3 id="方法一：重新设置证书"><a href="#方法一：重新设置证书" class="headerlink" title="方法一：重新设置证书"></a>方法一：重新设置证书</h3><p>在集群的每台服务器上面设置一下证书（如果执行第一行命令就报错的话，请把\$WL_HOME换成实际安装目录）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">. <span class="variable">$WL_HOME</span>/server/bin/setWLSEnv.sh</span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$WL_HOME</span>/server/lib</span><br><span class="line">java utils.CertGen -keyfilepass DemoIdentityPassPhrase -certfile newcert -keyfile newkey</span><br><span class="line">java utils.ImportPrivateKey -keystore DemoIdentity.jks -storepass DemoIdentityKeyStorePassPhrase -keyfile newkey.pem -keyfilepass DemoIdentityPassPhrase -certfile newcert.pem -<span class="built_in">alias</span> demoidentity</span><br></pre></td></tr></table></figure>
<h3 id="方法二：不使用SSL"><a href="#方法二：不使用SSL" class="headerlink" title="方法二：不使用SSL"></a>方法二：不使用SSL</h3><p>除此以外，还有一种做法是不使用SSL通信以避免出现证书问题：修改\$WL_HOME/common/nodemanager/nodemanager.properties文件，将其中的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SecureListener = true</span><br></pre></td></tr></table></figure>
<p>改成</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SecureListener = false</span><br></pre></td></tr></table></figure>
<p>然后重新启动NodeManager。另外在建立“计算机”时，类型就不再是“SSL”，而是“普通”（Plain）。</p>
<h2 id="组建集群"><a href="#组建集群" class="headerlink" title="组建集群"></a>组建集群</h2><p>我们并不需要每一台机器都执行一遍建域之类的操作。只要各服务器配置（例如JDK路径）差不多，那么在一台机器上面把Weblogic的各种参数都配置好，然后将user_projects目录打包（或者干脆把整个Middleware打包），复制到其他各服务器上面解压就差不多了。</p>
<p>如果Nodemanager使用SSL，解压完成后，前文提到的“Nodemanager证书”还是要在每台服务器上操作一遍。</p>
<h2 id="增加线程数"><a href="#增加线程数" class="headerlink" title="增加线程数"></a>增加线程数</h2><p>如果预计并发数比较高，可以增加应用线程池的线程数。修改config.xml配置文件（例如/opt/Oracle/Middleware/user_projects/base_domain/config/config.xml）。假如应用服务器叫app_server1，那么需要找到类似以下的代码</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">server</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>app_server1<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<p>修改成</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">server</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>app_server1<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">self-tuning-thread-pool-size-min</span>&gt;</span>1000<span class="tag">&lt;/<span class="name">self-tuning-thread-pool-size-min</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">self-tuning-thread-pool-size-max</span>&gt;</span>1000<span class="tag">&lt;/<span class="name">self-tuning-thread-pool-size-max</span>&gt;</span></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<p>需要注意的是，如果数值改得比较大，启动时可能会出现以下错误：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[ERROR][thread ] Could not start thread [ACTIVE] ExecuteThread: &apos;977&apos; for queue: &apos;weblogic.kernel.Default (self-tuning)&apos;. Resource temporarily unavailable</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Attempting to allocate 8192M bytes</span><br><span class="line"></span><br><span class="line">There is insufficient native memory for the Java</span><br><span class="line">Runtime Environment to continue.</span><br><span class="line"></span><br><span class="line">Possible reasons:</span><br><span class="line">  The system is out of physical RAM or swap space</span><br><span class="line">  In 32 bit mode, the process size limit was hit</span><br><span class="line"></span><br><span class="line">Possible solutions:</span><br><span class="line">  Reduce memory load on the system</span><br><span class="line">  Increase physical memory or swap space</span><br><span class="line">  Check if swap backing store is full</span><br><span class="line">  Use 64 bit Java on a 64 bit OS</span><br><span class="line">  Decrease Java heap size (-Xmx/-Xms)</span><br><span class="line">  Decrease number of Java threads</span><br><span class="line">  Decrease Java thread stack sizes (-Xss)</span><br><span class="line">  Disable compressed references (-XXcompressedRefs=false)</span><br><span class="line"></span><br><span class="line">java.lang.OutOfMemoryError: Resource temporarily unavailable in tsStartJavaThread (lifecycle.c:1097).</span><br></pre></td></tr></table></figure>
<p>报错信息看起来像是内存不足，实际上不是内存不足，而是Linux系统默认情况下限制了最大线程数，需要进行修改。</p>
<p>如果使用CentOS 6或RHEL6，可以按照以下方法进行修改：</p>
<p>首先修改/etc/security/limits.conf，加入<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">* hard nofile 1048576</span><br><span class="line">* soft nofile 1048576</span><br></pre></td></tr></table></figure></p>
<p>然后修改/etc/security/limits.d/90-nproc.conf，加入<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">weblogic   soft    nproc     655350</span><br></pre></td></tr></table></figure></p>
<p>最后修改/etc/pam.d/login，加入<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">session required /lib64/security/pam_limits.so</span><br></pre></td></tr></table></figure></p>
<p>修改完成后不要马上退出shell，要开个新窗口测试各账号能否登进去。如果登不进去（例如提示could not open session），说明参数改得太大，需要适当往小调。</p>
<h1 id="运维阶段"><a href="#运维阶段" class="headerlink" title="运维阶段"></a>运维阶段</h1><h2 id="应用升级"><a href="#应用升级" class="headerlink" title="应用升级"></a>应用升级</h2><p>改完文件之后要在控制台的“部署”里面进行更新，否则内容不会生效。改静态文件也是。</p>
<p>每次更新的时候，JVM会把Class信息保存到内存的永久保留区域中，而旧的内容不会释放。如果Weblogic启动参数中的-XX:MaxPermSize比较小，那么更新几次可能就会卡死挂掉，而且应用日志会显示“java.lang.OutOfMemoryError: PermGen space”。在这种情况下，把Weblogic里面的服务器停掉然后再启动一次就好了。</p>
<p>在开始更新到更新结束，应用会出现短暂的中断，因此要注意选择合适的时间进行操作。另外在业务繁忙时进行更新，不但会影响用户，而且容易因为Weblogic繁忙而导致更新无响应或失败。</p>
<p>如果更新时遭遇“Error occurred while downloading files from admin server for deployment request “xxx,xxx,xxx”. Underlying error is: “null””，那么需要去检查AdminServer.log的日志（例如/opt/Oracle/Middleware/user_projects/base_domain/servers/AdminServer/logs/AdminServer.log）。我碰到过两种会出现这种错误的情况，一种是文件名乱码，另一种是文件权限不正确（例如服务以weblogic用户运行，但是文件所有者是root，weblogic访问不了）。假如权限不正确，可以<code>chown -R weblogic:weblogic 存放程序的目录</code>。</p>
<div class="callout callout-note">
                <div class="callout-title">系统公告</div>
                <p>建议在系统中加入可配置参数的系统公告功能，这样在升级或者维护之前可以通知用户，使用户及时做好准备。</p>

            </div>
<h2 id="重启服务器"><a href="#重启服务器" class="headerlink" title="重启服务器"></a>重启服务器</h2><p>如果只是重启应用节点，操作就比较简单，直接在控制台上操作即可。不过，在Weblogic控制台重启服务的时候不要点完“启动”就不管了，一定要等到状态显示为“RUNNING”之后再收工。如果变成“ADMIN”，那么可能是有报错，需要去应用服务器日志检查一下。若确认不耽误事（例如“java.lang.NoClassDefFoundError: com/ctc/wstx/stax/WstxInputFactory”）那么在控制台点一下“恢复”就好了。</p>
<p>整个重启的话就比较麻烦，大体上要按启动AdminServer（startWebLogic.sh）-&gt;NodeManager（startNodeManager.sh）-&gt;各应用节点（可以在控制台操作）的顺序操作。当然顺序不是规定死的，只要最终全部都能启动起来就行。</p>
<h2 id="打补丁"><a href="#打补丁" class="headerlink" title="打补丁"></a>打补丁</h2><p>安装补丁之前，需要检查bsu.sh文件（例如/opt/Oracle/Middleware/utils/bsu/bsu.sh），将其中的最大内存Xmx改大些，例如-Xmx2048m。因为打补丁实在太慢，等了半天出来的却是java.lang.OutOfMemoryError的话实在太憋屈。</p>
<p>打补丁可以随时操作，但是打完之后需要重启Weblogic才能生效。</p>
<h2 id="搬家"><a href="#搬家" class="headerlink" title="搬家"></a>搬家</h2><p>尽量不要搬家，因为Weblogic安装和建域之后会产生很多已经写好了路径的配置文件。即使将它们全部改成新路径，Middleware目录中还有个registry.dat，此文件记录了Weblogic的安装情况而且已经加密，如果贸然搬家会在升级等方面遇到麻烦。实在需要的话还是建立软链接比较好。</p>
<h2 id="监控"><a href="#监控" class="headerlink" title="监控"></a>监控</h2><p>建议在服务器上面安装专门的监控软件。像我们项目组那种服务器由用户管理，应用由项目组自行运维的情况，更要有自己的监控程序，这样在出现问题时也好及时定位、避免扯皮。</p>
<p>目前我们项目组自己写了一个监控脚本，在繁忙时期每隔10分钟、空闲时期每隔半小时把Weblogic控制台的一些常用指标记录到日志文件中（通过cron控制），<a href="https://github.com/infnan/scripts/blob/master/部署和运维/weblogic-monitor.sh" target="_blank" rel="noopener">代码见此</a>。</p>

        </div>

        <blockquote class="post-copyright">
    
    <div class="content">
        
<span class="post-time">
    最后更新时间：<time datetime="2018-11-28T03:40:06.383Z" itemprop="dateUpdated">2018-11-28 11:40:06</time>
</span><br>


        
    </div>
    
    <footer>
        <a href="https://plusnan.me">
            <img src="/img/myavatar.jpg" alt="InfNaN">
            InfNaN
        </a>
    </footer>
</blockquote>

        


        <div class="post-footer">
            
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Weblogic/">Weblogic</a></li></ul>


            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://plusnan.me/2018/11/02/weblogic-caution/&title=《Weblogic踩坑记录》 — 一点微小的博客&pic=https://plusnan.me/img/myavatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://plusnan.me/2018/11/02/weblogic-caution/&title=《Weblogic踩坑记录》 — 一点微小的博客&source=本文记录我在部署Weblogic时遇到的各种坑。其中JDK为1.6，Weblogic版本11g。" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://plusnan.me/2018/11/02/weblogic-caution/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《Weblogic踩坑记录》 — 一点微小的博客&url=https://plusnan.me/2018/11/02/weblogic-caution/&via=https://plusnan.me" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://plusnan.me/2018/11/02/weblogic-caution/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between flex-row-reverse">
  

  
    <div class="waves-block waves-effect next">
      <a href="/2018/07/15/to-new-employee/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">给校招新员工分享的一点人生的经验</h4>
      </a>
    </div>
  
</nav>



    


<section class="comments" id="comments">
    <div id="disqus_thread"></div>
    <script>
    var disqus_config = function () {
        this.page.url = 'https://plusnan.me/2018/11/02/weblogic-caution/';
        this.page.identifier = '/2018/11/02/weblogic-caution/';
    };
    var disqus_shortname = 'christ-wus-blog';
    lazyScripts.push('//' + disqus_shortname + '.disqus.com/embed.js')
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</section>
















</article>



</div>

        <footer class="footer">
    <div class="top">
        

        <p>
            
                <span><a href="/rss.xml" target="_blank" class="rss" title="rss"><i class="icon icon-lg icon-rss"></i></a></span>
            
            <span>博客内容遵循 <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a></span>
        </p>
    </div>
    <div class="bottom">
        <p><span>InfNaN &copy; 2018</span>
            <span>
                
                Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a>
            </span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://plusnan.me/2018/11/02/weblogic-caution/&title=《Weblogic踩坑记录》 — 一点微小的博客&pic=https://plusnan.me/img/myavatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://plusnan.me/2018/11/02/weblogic-caution/&title=《Weblogic踩坑记录》 — 一点微小的博客&source=本文记录我在部署Weblogic时遇到的各种坑。其中JDK为1.6，Weblogic版本11g。" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://plusnan.me/2018/11/02/weblogic-caution/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《Weblogic踩坑记录》 — 一点微小的博客&url=https://plusnan.me/2018/11/02/weblogic-caution/&via=https://plusnan.me" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://plusnan.me/2018/11/02/weblogic-caution/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACMElEQVR42u3aQXLCMAwF0N7/0nSmKzaQLyl0iPK8ykBw/LIwsqSfn3g8/sbz9fMn7+9/9atXc76feTQwMDAuy3i8Ha8emS86WVbOezknBgbGDRjVqRNGvtUmdx6sGQMDA+PtRlxdaPUVYGBgYEw23GRZ1ReBgYGBMTnEVh+WZMaSlNzJZ3EMDIwLMnqFgf+5/nh9AwMD4+sZj9bIC5OTwkNhPRgYGKsZefPEJA3Xa9ooB6AYGBirGb0lnpDKj2O88qvHwMBYxKhusnmw2EvS5dtx+Q1hYGBclpGXGHuRWHKs7ZEO/jEwMDAWMfIjaPXb5DoPIss1WAwMjHWMXqND/ttJcTRZFQYGxn0YSSBYDfLylNkEg4GBsZtRzVnlqf95sFgNHzEwMO7AyMuQeaFxXiqovmIMDIx9jElfxqTcmISY+WaNgYGxmzEJ9XoNZJP7D9aMgYGxlDFPbPWCuWoR4uC5GBgYqxm9Rq55ui2Zv1oqwMDA2M0oZ+aqzRDjOav3YGBg7GPkLRRJASAP8qrPPVgDBgbGDRjVkRcs88zf5LkYGBi7GclRNj+Izg+0J/SMYGBgLGLMN9lemqy67R5s2RgYGKsZ1W2u1+z1iVaw3maNgYFxXUbeDNF7fLL0XgUDAwPjboxzE2ejCmqcSYv+EzAwMG7PmBx680AzOdBiYGBgVEO63sy9Qy8GBsZ9GMkhdt4clqfnygMDA2M1Y1IYKKTD4gNt8vnJ9Q0MDIzvZfwC9ETbGYUGBVoAAAAASUVORK5CYII=" alt="微信分享二维码">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: false };


</script>

<script src="/js/main.min.js?v=1.7.2"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="/js/search.min.js?v=1.7.2" async></script>



<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>

<script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" async></script>








</body>
</html>
