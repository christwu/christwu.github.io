---
layout: post
title: 追番记（未完待续）
categories: 闲谈
---
《[约会大作战](https://www.bilibili.com/bangumi/media/md4188)》第三季终于开播，其中最令人揪心的事情就是会不会[崩坏](https://zh.moegirl.org/作画崩坏)。之前约战第二季就略微崩坏（OVA更严重，路人全部石化），再加上近期《[我喜欢的妹妹不是妹妹](https://zh.wikipedia.org/wiki/我喜歡的妹妹不是妹妹)》动画版[崩坏到可以载入史册的程度](https://zhuanlan.zhihu.com/p/5052246)，给追番留下了心理阴影，或者说就像运维时候听说有人升级失败一样。

作为[士织](https://zh.moegirl.org/五河士织)控，我表示第二季动画里的士织酱远不如小说原版那样传神，即使在剧场版也略逊一筹<sup>看在像[园田海未](https://zh.moegirl.org/园田海未)的份上就不计较了</sup>。然而，不幸的是，第三季虽然换成节操社<sup>J.C.STAFF</sup>制作，结果果然崩坏了。对于崩坏，我等（盗版）观众现在能做的事情只有：

1. 发扬阿Q精神；
2. 祈祷后续制作顺利，不再崩坏；
3. 下周继续追番。

<!-- more -->

# 发扬阿Q精神
* [https://www.bilibili.com/read/cv1856701](https://www.bilibili.com/read/cv1856701)

# 祈祷后续不再崩坏
（备注：图片为小说第14卷原图）
![祈祷后续制作顺利，不再崩坏](/img/2019-01-14-anime/dal14_p2.jpg)

# 继续追番
## Bilibili（本次并没有）
之前追番的时候，只要在电脑上安装[you-get](https://github.com/soimort/you-get)，然后一行命令就可以搞定了，例如邪教作品《[Love Live! Sunshine!!](https://www.bilibili.com/bangumi/media/md5062)》第二季的最后一话：

```bash
you-get --no-proxy -d "https://www.bilibili.com/bangumi/play/ep115324"
```

如果报403错，先检查一下you-get是不是最新版，毕竟B站也会采取些防爬虫的措施。

然而，在B站上面，约战第三季需要“开通大会员抢先看”，所以爬虫也是无能为力了，需要换地方找资源。

## 线上看（第一话）
约战周五晚上开播，这样的话可以先休息，等到周六早上再用Google搜索，就能搜到一些在线观看的网站了。

先前追过一些B站上面没有或需要会员才能看的番，这些番剧可以在一些线上看网站里面找到。打开网页之后，只要打开浏览器控制台，点击“网络”标签，然后点击页面上的播放按钮，就可以看到浏览器记录了番剧的URL，而且是mp4格式的，可以直接拿来看。

残念的是，这次扒出来的都是m3u8格式，即播放列表，里面只有三百多个ts视频片段的URL，而且每个网址写着“cloudflare”十个大字。因为没有爬Cloudflare的经验，所以先用守株待兔的方式，通过浏览器的“网络”把m3u8和三百多个片段URL都等出来。视频缓冲完成后，在控制台点右键，“Save as HAR with content”，将捕获记录保存成har文件。

请求和返回内容保存下来之后，ts视频片段就可以很容易通过脚本提取出来了：

{% tabs 提取资源 %}
<!-- tab JavaScript -->
```js
#!/usr/bin/env node
const Buffer = require('buffer').Buffer;
const fs = require('fs');
const path = require('path');

if (!process.argv[2] || !process.argv[3]) {
    console.error('node extract.js <har> <url regexp>');
    process.exit(1);
}

const [ har, pattern ] = [ process.argv[2], process.argv[3] ];

const file = JSON.parse(fs.readFileSync(har));
const entries = file.log.entries;

for (const entry of entries) {
    if (!entry.request || !entry.response || !entry.response.content) {
        continue;
    }

    const url = entry.request.url;
    if (new RegExp(pattern).exec(url)) {
        const content = entry.response.content;
        const fileName = path.basename(url);

        let output = content.text;
        if (content.encoding === 'base64') {
            output = Buffer.from(output, 'base64');
        }

        fs.writeFile(fileName, output, (err) => {
            if (err) {
                console.error("Error writing to", fileName, err);
            } else {
                console.log("Write successfully to", fileName);
            }
        });
    }
}
```

执行脚本

```bash
node extract.js download.har 'v\d*\.ts'         # 假设文件名是v123.ts之类的
node extract.js download.har '*\.m3u8'
```
<!-- endtab -->
{% endtabs %}

合并片段也很简单。安装ffmpeg，假如提取出来的播放列表叫01.m3u8，那么

```bash
awk -F/ '/\.ts$/ { printf("file '"'"'%s'"'"'\n", $NF); }' 01.m3u8 > 01.lst
ffmpeg -f concat -i 01.lst -c copy 01.ts
ffmpeg -i 01.ts -acodec copy -vcodec copy 01.mp4
```

从脚本执行结果上看，个人感觉第一话里面崩坏最严重的是[美九](https://zh.moegirl.org/诱宵美九)，[耶俱矢](https://zh.moegirl.org/八舞耶俱矢)和[夕弦](https://zh.moegirl.org/八舞夕弦)也有点糟糕，不过[七罪](https://zh.moegirl.org/七罪)倒还可以。

## 第二话
（未完待续）
