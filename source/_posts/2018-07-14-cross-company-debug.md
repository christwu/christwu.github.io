---
layout: post
title: 接口设计经验
category: 经验
tags: 
- Web
- 内网穿透
---
不同系统之间存取数据，技术上最简单的方式就是提供接口。既然是不同系统，那么大家很可能不是同一家单位，需要留意的事情也会更多。本文记录了一些接口设计、联调前后需要考虑的事情。总体上来讲，我们既要保证准确实现功能，又要留个心眼，保护自己的利益，避免让自己吃亏。
<!-- more --> 

# 设计
虽然接口的原理很简单，开发工作量可能也比其他开发工作少很多，但是需要留意，在业务问题上“我这样想”不代表“对方也会这样想”，并且开发时的沟通成本往往会比较高，上线之后一旦出现故障可能还会互相踢皮球，因此也不能把设计工作想象得太简单。

1. 约定好具体的数据格式、字符编码和收发方式！例如“传JSON”既可能是直接HTTP POST一段JSON（application/json），也可能是调用WebService，里面参数为JSON（application/xml），前者通常是在用户浏览器上通过AJAX调用，后者可能是自己后台直接调用对方的服务器，不经过用户的界面。如果连这个都弄错，后续发现问题时有可能要整个推倒重来；
2. 确保双方对于每个函数、每个参数的理解是一致的。特别是业务系统，对方对业务场景与业务的理解可能与我们很不一样，因此要多进行确认，及时更新和完善文档；
3. 搞清楚接口调用时机、频率，估计一下接口调用数据规模，避免因为频率不当或者数据规模太大而出问题；
4. 有异常处理机制，能够正确处理目标服务器宕机、返回404、长时间不返回等情况。接口恢复后，故障期间产生的数据能够正确消化掉；
5. 检查输入数据是否合法（格式正确、符合业务要求以及具有业务权限），例如拒绝不合规范的数据，以及避免用户改个ID就能查看或修改别人数据的情况；
6. 对于有状态的数据，约定好重复发送请求（例如用户或程序重复提交工作单）的后果；
7. 考虑专门的日志记录，例如使用专门的文件或在数据库建立接口日志表；
8. 有认证机制和访问控制机制，防止接口被无关厂商及人员冒用或恶意调用。

# 联调
**如果是不同公司之间进行合作，务必要留证据！**具体而言：

1. 记录哪天、与哪个人、调试了什么东西、结果如何；
2. 各接口函数要输出日志，记录时间、原始数据和一些关键数据；
3. 重要内容留截图。

推荐两个调试接口的软件，一个是专门测WebService的[SoapUI](https://www.soapui.org)，另一个是可以测各种请求的[Postman](https://www.getpostman.com/apps)。对我个人而言，由于我们项目经常是WebService里面套JSON，所以SoapUI用得并不舒服，不如自己抓到调用WebService的原始请求内容然后全部扔到Postman中调试：

```xml
<soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">
    <soap:Body>
        <ns1:xxxxxmethod xmlns:ns1="http://service.xxx.xxxcompany.com/">
            <arg0>
                {
                    "param1": "xxx",
                    "param2": "yyy",
                    ...
                }
            </arg0>
        </ns1:xxxxxmethod>
    </soap:Body>
</soap:Envelope>
```

如果主要系统已经上线了，注意不要在生产环境或使用生产库直接联调（顶多是试一试接口和主要功能通不通），而是要准备一个和生产环境架构相似的测试环境，在测试环境上进行联调。

# 运行
上线之后更要专门记录接口的调用情况，做到有据可查。清楚地了解接口调用情况、频率以及状态，在出现故障时可以尽量避免踢皮球和承担无谓责任。有必要的话还应该实行访问控制，一旦遭遇攻击或疑似攻击（例如调用频率太高等）时可以方便地进行处理。

# 补充技巧：内网穿透
理想情况下应该建立一个双方都便于访问的开发测试区。如果没有条件或者来不及准备，而且双方公司都能访问互联网，可以通过内网穿透的方法把本地应用映射到公网上。

操作之前去搞一台VPS。我个人推荐[Vultr](https://vultr.com)，因为国外不需要实名认证，而且Vultr按使用时间计费，可以随时买随时扔。对于内网穿透而言，$5的VPS足矣。

{% callout .note 关于Vultr的VPS %}
部署时建议选择洛杉矶或东京节点，这两个网络相对而言比较好。除了\$5的机器外，有时能看到更便宜的\$2.5机器，但是它们没有IPv4地址，所以要慎重购买。
{% endcallout %}

以Ubuntu系统为例，使用之前先在公司Ping一下，Ping不通说明被墙了，销毁之后再买一台即可。没问题的话，

```bash
sudo nano /etc/ssh/sshd_config
```

将其中的`GatewayPorts no`改成`yes`，没找到的话就在文件末尾追加一行，保存。然后

```bash
sudo systemctl restart sshd
```

准备工作就做好了。

联调时先去下载PuTTY，启动，在里面输入服务器地址和端口（默认22），并且按下图进行设置

![PuTTY设置](/img/cross-company-debug/putty-tunnel.png)

不要忘记点Add按钮。假如本机是`http://172.18.106.3:8080`，服务器IP是198.13.60.108，你选择的端口是8080，那么登录成功后就可以通过`http://198.13.60.108:8080`来访问自己的应用了。
