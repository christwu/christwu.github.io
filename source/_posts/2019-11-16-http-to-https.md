---
layout: post
title: 基于第三方CDN的HTTPS改造实施方案
category: 运维
tags:
- CDN
- HTTPS
---
为了提升Web系统安全性，我们需对生产系统进行HTTPS改造，改造实质上可以通过套CDN来实现。本文即整个改造工作的实施方案。
<!-- more -->

（本文系统架构、域名、IP均为虚构）

# 改造目标
1. 部署CDN
2. 通过CDN实现HTTPS支持

# 系统部署架构
系统为传统的Web应用部署架构。系统分为PC端和微信端两部分，域名和IP分别为 www.xxx.com (xx.yy.zz.aa) 与 weixin.xxx.com (xx.yy.zz.bb)。

```
Internet        |             机房内网
                |
PC端用户--------网关---负载均衡1---PC端应用服务器（集群）
                |                      ↑           ↖︎
                |                  数据库服务器     某些第三方接口
                |                      ↓           ↙︎
微信用户--微信---网关---负载均衡2---微信端应用服务器（集群）
                |
```

加入CDN后将变为

```
Internet              |             机房内网
                      |
PC端用户------\        |   /-负载均衡1---PC端应用服务器（集群）
              \    /-网关-/                   ↑           ↖︎
              CDN--   |                  数据库服务器     某些第三方接口
              /    \-网关-\                   ↓           ↙︎
微信用户--微信-/        |   \-负载均衡2---微信端应用服务器（集群）
                      |
```

# 准备工作
## 沟通协调
改造工作，技术不是什么难题，难就难在让不同单位不同部门之间协调一致。实施之前，确认以下各环节具体负责人，提前做好协调沟通工作：

* 总负责人（包括业务方面和技术方面的总负责）：汇报改造工作目的、内容、预期效果和实施风险，征求领导同意。
* 应用系统负责人：负责应用系统改造，确保切换HTTPS之后系统能正常运行。
    * 对接的第三方接口负责人：同步调整应用URL。
    * 微信公众号负责人：同步调整微信公众号后台API的URL。
* HTTPS证书管理员：负责提供HTTPS证书。
* CDN对接人：负责调整CDN设置，包括引入CDN加速、导入HTTPS证书等。
* 域名管理员：负责在CDN设置好之后调整域名的CNAME记录。

约定好实施日期与负责人联系方式，后面部分工作需各方同步进行。

## 域名
由于域名已准备好，无需再做准备工作，否则要事先把一二级域名准备好并完成备案。

务必将www.xxx.com与weixin.xxx.com解析出的IP记录下来，否则套CDN之后再想找源头IP会很麻烦。

## HTTPS证书
需购买HTTPS证书。具体内容本文不再讨论。

## CDN服务
需购买第三方CDN服务，并调好基本设置，准备随时启用。

## 应用程序改造
需对应用程序进行排查和改造，防止协议升级之后无法访问。改造完成后，需使用HTTPS域名进行测试，避免生产环境发生异常。

### URL排查
浏览器通常会阻止加载Mixed Content（HTTPS页面中的HTTP资源），因此需检查前端代码和后端代码中是否有写死的网址（可用查找功能搜索“http://”），如果有http，需修改成无协议网址（例如`//www.xxx.com/static/js/xxx.js`）或https。

需要特别留意AJAX请求和POST请求。改造完成后，访问HTTP，可能会被302到HTTPS页面中，而302跳转不仅对效率有影响，还无法正确处理POST请求。

### 安全组件排查
如果应用中有安全组件（例如[简单粗暴的那种](/2019/08/25/security-filter)），需检查URL由HTTP修改为HTTPS之后是否会被错误地拦截。

### 接口排查
如果对接厂商使用了我们的域名，需通知相关厂商同步调整系统URL。

# 实施工作
## 用户公告
提前通知用户：系统将进行维护，为避免业务数据丢失，请尽量避免在系统维护时段办理业务。

## 系统部署
分为应用程序部署、CDN部署与域名CNAME记录调整，这三项操作需同步进行。

### 应用程序部署
我们和第三方接口对接厂商需及时将新版应用部署到生产环境。

### CDN部署
首先，在CDN控制台需开启两个网站的加速：

| 域名              | 回源地址       | 端口       |
|-------------------|--------------|------------|
| www.xxx.com       | xx.yy.zz.aa  | 80         |
| weixin.xxx.com    | xx.yy.zz.bb  | 80         |

其次需上传HTTPS证书，或通过其他CDN平台支持的方式导入证书，然后再开启HTTPS支持。

在不同CDN厂商控制台中，HTTPS支持的形式可能不同。可根据自己需要来决定继续提供HTTP访问，还是全部重定向到HTTPS。无论如何调整参数，我们需记住，HTTP到HTTPS的升级是由CDN来实现的，原站没有进行改动，始终是HTTP协议、80端口。

### 域名CNAME记录调整
CDN设置好之后，需登录域名管理控制台，按照CDN平台所提供信息修改 www.xxx.com 和 weixin.xxx.com 的CNAME记录。

## 微信后台调整
登录微信公众号管理界面，修改API的地址，由HTTP改为HTTPS。

如果公众号有菜单，且菜单中涉及 weixin.xxx.com 的URL，那么需要更新一下公众号菜单。

## 网络策略调整
调整服务器网络策略，放行CDN节点的IP地址。在域名记录修改彻底生效之后，可进一步增加策略，拦截除CDN之外的所有IP访问。

# 验证
由于域名CNAME调整可能不会马上生效，需要通过修改hosts的方式进行访问验证。系统正常运行则说明改造完成。
